# ---------- Production ----------
  FROM node:18-alpine AS production
  WORKDIR /app
  
  RUN addgroup -g 1001 -S nodejs && adduser -S nestjs -u 1001
  
  COPY package*.json ./
  RUN npm ci --omit=dev && npm cache clean --force
  
  # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð±Ð¸Ð»Ð´
  COPY --from=builder /app/dist ./dist
  
  # ðŸ”§ Ð’ÐÐ–ÐÐž: Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚Ñ‹ Ð¸, Ð¿Ñ€Ð¸ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸, Ð¿Ð°Ð¿ÐºÑƒ database
  COPY scripts ./scripts
  COPY database ./database
  
  USER nestjs
  EXPOSE 3001
  
  HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD node -e "require('http').get('http://localhost:3001/health', r=>process.exit(r.statusCode===200?0:1))"
  
  CMD ["node", "dist/main.js"]